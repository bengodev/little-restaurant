{% extends "admin/base.html" %}
{% load static %}
{% load auth_extras %}

{% comment %} 
This template extends base.html and is used to customize the header and title of the admin site. 
It is specifically designed to override the branding and title section of the admin interface.
{% endcomment %}


{% block footer %}
    {{ block.super }}

    <!-- 1.  Toast CSS (tiny, inline) -->
    <style>
        #toast{
            position:fixed; top:20px; right:20px;
            background:#28a745; color:#fff; padding:10px 14px;
            border-radius:4px; z-index:9999; display:none;
            font-size:14px; box-shadow:0 2px 8px rgba(0,0,0,.2);
        }
    </style>

    <!-- 2.  WebSocket script -->
  
{% if user.is_superuser or user.is_staff %}

  <script>
    // === Notification System ===
    let notificationCount = 0;
    const countEl = document.getElementById('notification-count');
    const iconEl = document.getElementById('notification-icon');
    const popupEl = document.createElement('div');
    popupEl.className = 'notification-popup';
    document.body.appendChild(popupEl);

    // WebSocket Connection
    const ws = new WebSocket(`wss://${window.location.host}/ws/booking/`);

    ws.onopen = function() {
      console.log('WebSocket connection opened');
    };

    ws.onmessage = function(e) {
      const msg = JSON.parse(e.data);
      console.log("New booking:", msg.data);

      // Increment notification count
      notificationCount++;
      updateBadge();
      
      // Play sound
      new Audio("{% static 'upbeat.mp3' %}").play();

      // Optional: Add to popup
      addNotificationToPopup(msg.data);
    };

    ws.onclose = function(e) {
      console.log('WebSocket closed');
    };

    // === UI Functions ===
    function updateBadge() {
      if (notificationCount > 0) {
        countEl.textContent = notificationCount;
        countEl.style.display = 'flex';
      } else {
        countEl.style.display = 'none';
      }
    }

    function addNotificationToPopup(data) {
      const item = document.createElement('div');
      item.className = 'notification-item';
      item.textContent = `New booking: ${data.name || 'Unknown'} at ${data.date || 'Unknown time'} for ${data.guests || 'Unknown people'} people`;
      popupEl.prepend(item); // Most recent first
    }

    // Toggle popup on click
    iconEl.addEventListener('click', (e) => {
      e.stopPropagation();
      if (popupEl.style.display === 'block') {
        popupEl.style.display = 'none';
      } else {
        popupEl.style.display = 'block';
      }
    });

    // Close popup on outside click
    document.addEventListener('click', () => {
      popupEl.style.display = 'none';
    });

    popupEl.addEventListener('click', (e) => e.stopPropagation());

    // Mark all as read on click
    iconEl.addEventListener('click', () => {
      if (notificationCount > 0) {
        notificationCount = 0;
        updateBadge();
        document.title = document.title.replace(/\(ðŸ””\) /, ''); // Remove flash
      }
    });

    // Flash title on new notification
    function flashTitle() {
      const original = document.title;
      let blink = true;
      const timer = setInterval(() => {
        document.title = blink ? '(ðŸ””) ' + original : original;
        blink = !blink;
      }, 1000);
      setTimeout(() => clearInterval(timer), 5000);
    }

    // Optional: Flash title on new notification
    ws.onmessage = function(e) {
      const msg = JSON.parse(e.data);
      console.log("New booking:", msg.data);

      notificationCount++;
      updateBadge();
      new Audio("{% static 'upbeat.mp3' %}").play();
      addNotificationToPopup(msg.data);
      flashTitle();  // Optional visual alert
    };
  </script>

{% comment %} <script src="/js/websocket.js"></script> {% endcomment %}
      {% comment %} <script>
      console.log('New WebSocket line creating');

      const ws = new WebSocket(`ws://${window.location.host}/ws/booking/`);

      ws.onopen = function() {
          console.log('WebSocket connection opened');
      };

      ws.onmessage = function(e) {
          const msg = JSON.parse(e.data);
          console.log("new row:", msg.data);
          new Audio("{% static 'upbeat.mp3' %}").play();
      };

      ws.onclose = function() {
          console.log('WebSocket connection closed');
      };

      ws.onerror = function(error) {
          console.log('WebSocket error: ', error);
      };
  </script> {% endcomment %}
{% endif %}
{% endblock %}
